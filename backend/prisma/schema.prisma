// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum TipoUsuario {
  MOTORISTA
  DONO_POSTO
  ADMINISTRADOR
}

enum TipoCombustivel {
  GASOLINA_COMUM
  GASOLINA_ADITIVADA
  ETANOL
  DIESEL_COMUM
  DIESEL_S10
  GNV
}

enum TipoCupom {
  PORCENTAGEM
  VALOR_FIXO
}

// ============================================
// MODELS
// ============================================

model Usuario {
  id           String      @id @default(uuid())
  email        String      @unique
  senha        String
  nome         String
  tipo         TipoUsuario @default(MOTORISTA)
  criadoEm     DateTime    @default(now()) @map("criado_em")
  atualizadoEm DateTime    @updatedAt @map("atualizado_em")

  avaliacoes   Avaliacao[]
  cuponsUsados CupomUsuario[]
  posto        Posto?

  @@map("usuarios")
}

model Posto {
  id        String  @id @default(uuid())
  nome      String
  endereco  String
  latitude  Float
  longitude Float
  parceiro  Boolean @default(false)

  donoId String  @unique @map("dono_id")
  dono   Usuario @relation(fields: [donoId], references: [id], onDelete: Cascade)

  criadoEm     DateTime @default(now()) @map("criado_em")
  atualizadoEm DateTime @updatedAt @map("atualizado_em")

  precos     Preco[]
  avaliacoes Avaliacao[]
  cupons     Cupom[]

  @@map("postos")
}

model Preco {
  id              String          @id @default(uuid())
  tipoCombustivel TipoCombustivel @map("tipo_combustivel")
  valor           Decimal         @db.Decimal(10, 3)
  fonteFoto       String?         @map("fonte_foto")
  atualizadoEm    DateTime        @default(now()) @map("atualizado_em")

  postoId String @map("posto_id")
  posto   Posto  @relation(fields: [postoId], references: [id], onDelete: Cascade)

  @@unique([postoId, tipoCombustivel])
  @@map("precos")
}

model Avaliacao {
  id         String   @id @default(uuid())
  nota       Int // 1-5
  comentario String?
  criadoEm   DateTime @default(now()) @map("criado_em")

  usuarioId String  @map("usuario_id")
  usuario   Usuario @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  postoId String @map("posto_id")
  posto   Posto  @relation(fields: [postoId], references: [id], onDelete: Cascade)

  @@map("avaliacoes")
}

model Cupom {
  id          String    @id @default(uuid())
  codigo      String    @unique
  tipo        TipoCupom
  valor       Decimal   @db.Decimal(10, 2)
  valorMinimo Decimal?  @map("valor_minimo") @db.Decimal(10, 2)
  dataInicio  DateTime  @map("data_inicio")
  dataFim     DateTime  @map("data_fim")
  ativo       Boolean   @default(true)

  postoId String @map("posto_id")
  posto   Posto  @relation(fields: [postoId], references: [id], onDelete: Cascade)

  usuariosUsaram CupomUsuario[]

  criadoEm     DateTime @default(now()) @map("criado_em")
  atualizadoEm DateTime @updatedAt @map("atualizado_em")

  @@map("cupons")
}

model CupomUsuario {
  id      String   @id @default(uuid())
  usadoEm DateTime @default(now()) @map("usado_em")

  cupomId String @map("cupom_id")
  cupom   Cupom  @relation(fields: [cupomId], references: [id], onDelete: Cascade)

  usuarioId String  @map("usuario_id")
  usuario   Usuario @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  @@unique([cupomId, usuarioId])
  @@map("cupons_usuarios")
}
